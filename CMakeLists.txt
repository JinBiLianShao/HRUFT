####################################################################################################
# ğŸ“˜ é€šç”¨ CMake æ„å»ºç³»ç»Ÿæ¨¡æ¿è¯´æ˜æ–‡æ¡£ï¼ˆæ”¯æŒç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“ï¼‰
# ä½œè€… ï¼š è¿æ€é‘«
# æœ¬æ„å»ºç³»ç»Ÿæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
#   âœ… è‡ªåŠ¨æ”¶é›†æºæ–‡ä»¶å’Œå¤´æ–‡ä»¶
#   âœ… æ”¯æŒä¸‰ç§æ„å»ºç›®æ ‡ï¼šå¯æ‰§è¡Œæ–‡ä»¶ / é™æ€åº“ / åŠ¨æ€åº“
#   âœ… é€‚é…å¤šå¹³å°äº¤å‰ç¼–è¯‘ï¼ˆx86ã€arm32ã€arm64ï¼‰
#   âœ… é“¾æ¥å¤–éƒ¨é™æ€åº“ï¼ˆå¦‚ SQLiteï¼‰
#   âœ… å¯é€‰å¯ç”¨ OpenMP æ”¯æŒ
#   âœ… ç¼–è¯‘é€‰é¡¹é›†ä¸­ç®¡ç†ï¼Œæ˜“æ‰©å±•
#
# ğŸ“ æ¨èé¡¹ç›®ç›®å½•ç»“æ„ï¼š
#   project_root/
#   â”œâ”€â”€ CMakeLists.txt
#   â”œâ”€â”€ src/                # é¡¹ç›®æºæ–‡ä»¶
#   â”œâ”€â”€ include/            # é¡¹ç›®å¤´æ–‡ä»¶
#   â”œâ”€â”€ lib/                # å¯é€‰æœ¬åœ°åº“
#   â”œâ”€â”€ build/              # æ„å»ºç›®å½•
#   â””â”€â”€ external/           # ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ Sqliteï¼‰
#
# ğŸ§© å¯é…ç½®é€‰é¡¹ï¼ˆé€šè¿‡å‘½ä»¤è¡Œä¼ å…¥ï¼‰ï¼š
#   -DCOMPILER_TARGET=x86|arm32|arm64             # ç›®æ ‡å¹³å°
#   -DPUBLIC_PACKAGE_DIR=/path/to/packages|NO     # ç¬¬ä¸‰æ–¹åº“è·¯å¾„ / NOè¡¨ç¤ºä¸å¼•å…¥ç¬¬ä¸‰æ–¹åº“è·¯å¾„
#   -DCMAKE_BUILD_TYPE=Release|Debug              # æ„å»ºç±»å‹
#   -DENABLE_OPENMP=ON|OFF                        # æ˜¯å¦å¯ç”¨ OpenMP
#   -DTARGET_TYPE=executable|static|shared        # ç›®æ ‡ç±»å‹ï¼šå¯æ‰§è¡Œ / é™æ€åº“ / åŠ¨æ€åº“
#
# âœ… æ„å»ºç¤ºä¾‹ï¼š
#   mkdir build && cd build
#   cmake .. -DCOMPILER_TARGET=arm32 -DPUBLIC_PACKAGE_DIR=/home/lsx/PublicPackage -DTARGET_TYPE=static
#   make -j
#
####################################################################################################

cmake_minimum_required(VERSION 3.10)

# é¡¹ç›®åç§°ä¸è¯­è¨€
if (NOT DEFINED PROJECT_NAME)
    set(PROJECT_NAME "hruft")
endif ()
project(${PROJECT_NAME} LANGUAGES C CXX)

# æ„å»ºç±»å‹é»˜è®¤å€¼
if (NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type (Release or Debug)" FORCE)
endif ()

# ç¼–è¯‘æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ===================== ç”¨æˆ·é…ç½®å˜é‡ =====================
set(COMPILER_TARGET "x86" CACHE STRING "Target architecture: x86, arm32, arm64")
set(PUBLIC_PACKAGE_DIR "NO" CACHE PATH "External packages root path or NO")
set(TARGET_TYPE "executable" CACHE STRING "Build target type: executable | static | shared")
option(ENABLE_OPENMP "Enable OpenMP parallelism" OFF)
# ========================================================

# ===================== æ˜¯å¦å¯ç”¨å¤–éƒ¨åŒ… =====================
set(USE_PUBLIC_PACKAGE ON)
if (PUBLIC_PACKAGE_DIR STREQUAL "NO")
    set(USE_PUBLIC_PACKAGE OFF)
endif ()
# ==========================================================

# ===================== æ¶æ„ä¸äº¤å‰ç¼–è¯‘ =====================
if (COMPILER_TARGET STREQUAL "arm64")
    set(CMAKE_SYSTEM_NAME Linux)
    set(CMAKE_C_COMPILER "/bin/aarch64-linux-gnu-gcc")
    set(CMAKE_CXX_COMPILER "/bin/aarch64-linux-gnu-g++")

elseif (COMPILER_TARGET STREQUAL "arm32")
    set(CMAKE_SYSTEM_NAME Linux)
    set(CMAKE_C_COMPILER "/opt/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-gcc")
    set(CMAKE_CXX_COMPILER "/opt/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-g++")


elseif (COMPILER_TARGET STREQUAL "x86")
    set(CMAKE_C_COMPILER "gcc")
    set(CMAKE_CXX_COMPILER "g++")

else ()
    message(FATAL_ERROR "Unsupported COMPILER_TARGET: ${COMPILER_TARGET}")
endif ()

link_directories(${SQLITE_LIB_DIR})

# ===================== è‡ªåŠ¨æ”¶é›†æºæ–‡ä»¶ä¸å¤´æ–‡ä»¶ =====================
file(GLOB_RECURSE SRC_FILES
        "${CMAKE_SOURCE_DIR}/*.cpp"
        "${CMAKE_SOURCE_DIR}/*.cc"
)

file(GLOB_RECURSE HEADER_FILES
        "${CMAKE_SOURCE_DIR}/*.h"
        "${CMAKE_SOURCE_DIR}/*.hpp"
)

if (USE_PUBLIC_PACKAGE)
    file(GLOB_RECURSE EXT_SRC_FILES
            "${PUBLIC_PACKAGE_DIR}/*.cpp"
            "${PUBLIC_PACKAGE_DIR}/*.cc"
    )
    file(GLOB_RECURSE EXT_HDR_FILES
            "${PUBLIC_PACKAGE_DIR}/*.h"
            "${PUBLIC_PACKAGE_DIR}/*.hpp"
    )
    list(APPEND SRC_FILES ${EXT_SRC_FILES})
    list(APPEND HEADER_FILES ${EXT_HDR_FILES})
endif ()

# æ’é™¤æ„å»ºç›®å½•æ–‡ä»¶
list(FILTER SRC_FILES EXCLUDE REGEX "${CMAKE_BINARY_DIR}")
list(FILTER SRC_FILES EXCLUDE REGEX ".*/CMakeFiles/.*")
list(FILTER SRC_FILES EXCLUDE REGEX "${CMAKE_BINARY_DIR}/.*")


# æå–å”¯ä¸€å¤´æ–‡ä»¶ç›®å½•
set(INCLUDE_DIRS "")
foreach (HDR ${HEADER_FILES})
    get_filename_component(DIR ${HDR} DIRECTORY)
    list(APPEND INCLUDE_DIRS ${DIR})
endforeach ()
list(REMOVE_DUPLICATES INCLUDE_DIRS)

# ===================== æ„å»ºç›®æ ‡å®šä¹‰ =====================
if (TARGET_TYPE STREQUAL "executable")
    add_executable(${PROJECT_NAME} ${SRC_FILES})
elseif (TARGET_TYPE STREQUAL "static")
    add_library(${PROJECT_NAME} STATIC ${SRC_FILES})
elseif (TARGET_TYPE STREQUAL "shared")
    add_library(${PROJECT_NAME} SHARED ${SRC_FILES})
else ()
    message(FATAL_ERROR "Invalid TARGET_TYPE: ${TARGET_TYPE} (must be executable|static|shared)")
endif ()

# åŒ…å«å¤´æ–‡ä»¶è·¯å¾„
target_include_directories(${PROJECT_NAME} PUBLIC ${INCLUDE_DIRS})

# ===================== é“¾æ¥åº“è®¾ç½® =====================
# åªæœ‰æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶æ—¶æ‰é“¾æ¥ç³»ç»Ÿåº“
if (TARGET_TYPE STREQUAL "executable")
    target_link_libraries(${PROJECT_NAME}
            PRIVATE
            pthread
            rt
            dl
            m
            "-Wl,--start-group"
            "-Wl,--end-group"
    )

    # é“¾æ¥å®‰å…¨è®¾ç½®ï¼ˆä»…é™å¯æ‰§è¡Œï¼‰
    set_target_properties(${PROJECT_NAME} PROPERTIES
            LINK_WHAT_YOU_USE TRUE
    )
endif ()

# ===================== OpenMP æ”¯æŒï¼ˆå¯é€‰ï¼‰ =====================
option(ENABLE_OPENMP "Enable OpenMP parallelism" OFF)

if (ENABLE_OPENMP)
    find_package(OpenMP REQUIRED)
    if (OpenMP_FOUND)
        message(STATUS "OpenMP enabled")
        target_compile_options(${PROJECT_NAME} PRIVATE ${OpenMP_C_FLAGS} ${OpenMP_CXX_FLAGS})
        target_link_libraries(${PROJECT_NAME} PRIVATE ${OpenMP_EXE_LINKER_FLAGS})
    endif ()
endif ()
