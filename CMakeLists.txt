####################################################################################################
# ğŸ“˜ é€šç”¨ CMake æ„å»ºç³»ç»Ÿæ¨¡æ¿è¯´æ˜æ–‡æ¡£ï¼ˆæ”¯æŒç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“ï¼‰
# ä½œè€… ï¼š è¿æ€é‘«
# æœ¬æ„å»ºç³»ç»Ÿæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
#   âœ… è‡ªåŠ¨æ”¶é›†æºæ–‡ä»¶å’Œå¤´æ–‡ä»¶
#   âœ… æ”¯æŒä¸‰ç§æ„å»ºç›®æ ‡ï¼šå¯æ‰§è¡Œæ–‡ä»¶ / é™æ€åº“ / åŠ¨æ€åº“
#   âœ… é€‚é…å¤šå¹³å°äº¤å‰ç¼–è¯‘ï¼ˆx86ã€arm32ã€arm64ï¼‰
#   âœ… é“¾æ¥å¤–éƒ¨é™æ€åº“ï¼ˆå¦‚ SQLiteï¼‰
#   âœ… å¯é€‰å¯ç”¨ OpenMP æ”¯æŒ
#   âœ… ç¼–è¯‘é€‰é¡¹é›†ä¸­ç®¡ç†ï¼Œæ˜“æ‰©å±•
#
# ğŸ“ æ¨èé¡¹ç›®ç›®å½•ç»“æ„ï¼š
#   project_root/
#   â”œâ”€â”€ CMakeLists.txt
#   â”œâ”€â”€ src/                # é¡¹ç›®æºæ–‡ä»¶
#   â”œâ”€â”€ include/            # é¡¹ç›®å¤´æ–‡ä»¶
#   â”œâ”€â”€ lib/                # å¯é€‰æœ¬åœ°åº“
#   â”œâ”€â”€ build/              # æ„å»ºç›®å½•
#   â””â”€â”€ external/           # ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ Sqliteï¼‰
#
# ğŸ§© å¯é…ç½®é€‰é¡¹ï¼ˆé€šè¿‡å‘½ä»¤è¡Œä¼ å…¥ï¼‰ï¼š
#   -DCOMPILER_TARGET=x86|arm32|arm64             # ç›®æ ‡å¹³å°
#   -DPUBLIC_PACKAGE_DIR=/path/to/packages|NO     # ç¬¬ä¸‰æ–¹åº“è·¯å¾„ / NOè¡¨ç¤ºä¸å¼•å…¥ç¬¬ä¸‰æ–¹åº“è·¯å¾„
#   -DCMAKE_BUILD_TYPE=Release|Debug              # æ„å»ºç±»å‹
#   -DENABLE_OPENMP=ON|OFF                        # æ˜¯å¦å¯ç”¨ OpenMP
#   -DTARGET_TYPE=executable|static|shared        # ç›®æ ‡ç±»å‹ï¼šå¯æ‰§è¡Œ / é™æ€åº“ / åŠ¨æ€åº“
#   -DTARGET_OS=linux|windows                     # ç›®æ ‡æ“ä½œç³»ç»Ÿ

# âœ… æ„å»ºç¤ºä¾‹ï¼š
#   mkdir build && cd build
#   cmake .. -DCOMPILER_TARGET=arm32 -DPUBLIC_PACKAGE_DIR=/home/lsx/PublicPackage -DTARGET_TYPE=static
#   make -j

# âœ… è·¨å¹³å°æ„å»ºç¤ºä¾‹ï¼š
#   (Linux)   cmake .. -DTARGET_OS=linux -DCOMPILER_TARGET=x86
#   (Windows) cmake .. -DTARGET_OS=windows
####################################################################################################

cmake_minimum_required(VERSION 3.10)

# ---------------------------------------------------------------------------------------
# 1. é¡¹ç›®åŸºç¡€é…ç½®
# ---------------------------------------------------------------------------------------
if (NOT DEFINED PROJECT_NAME)
    set(PROJECT_NAME "hruft")
endif ()
project(${PROJECT_NAME} LANGUAGES C CXX)

# è®¾ç½®æ„å»ºç±»å‹ (Debug/Release)
if (NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif ()

# å¼ºåˆ¶ C++17 æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ---------------------------------------------------------------------------------------
# 2. ç”¨æˆ·é€‰é¡¹ç›®å½•
# ---------------------------------------------------------------------------------------
set(TARGET_OS "linux" CACHE STRING "Target OS: linux, windows")
set(COMPILER_TARGET "x86" CACHE STRING "Target architecture: x86, arm32, arm64")
set(PUBLIC_PACKAGE_DIR "NO" CACHE PATH "External packages root path or NO")
set(TARGET_TYPE "executable" CACHE STRING "Build target type: executable | static | shared")
option(ENABLE_OPENMP "Enable OpenMP parallelism" OFF)

# ---------------------------------------------------------------------------------------
# 3. ç¼–è¯‘å™¨ä¸äº¤å‰ç¼–è¯‘é€»è¾‘
# ---------------------------------------------------------------------------------------
if (TARGET_OS STREQUAL "windows")
    # --- Windows å¹³å°é…ç½® ---
    add_definitions(-D_CRT_SECURE_NO_WARNINGS) # å¿½ç•¥ MSVC å®‰å…¨è­¦å‘Š
    message(STATUS "Build Mode: Windows")

    # å¦‚æœåœ¨ Linux ä¸‹ä½¿ç”¨ MinGW äº¤å‰ç¼–è¯‘ Windows
    if (CMAKE_HOST_SYSTEM_NAME MATCHES "Linux")
        set(CMAKE_SYSTEM_NAME Windows)
        set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)
        set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++)
    endif()

else()
    # --- Linux å¹³å°é…ç½® ---
    message(STATUS "Build Mode: Linux, Target Arch: ${COMPILER_TARGET}")

    if (COMPILER_TARGET STREQUAL "arm64")
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_C_COMPILER "/bin/aarch64-linux-gnu-gcc")
        set(CMAKE_CXX_COMPILER "/bin/aarch64-linux-gnu-g++")

    elseif (COMPILER_TARGET STREQUAL "arm32")
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_C_COMPILER "/opt/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-gcc")
        set(CMAKE_CXX_COMPILER "/opt/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf/bin/arm-linux-gnueabihf-g++")

    elseif (COMPILER_TARGET STREQUAL "x86")
        set(CMAKE_C_COMPILER "gcc")
        set(CMAKE_CXX_COMPILER "g++")
    endif()
endif()

# ---------------------------------------------------------------------------------------
# 4. è‡ªåŠ¨æ”¶é›†æºæ–‡ä»¶ä¸å¤´æ–‡ä»¶
# ---------------------------------------------------------------------------------------
# é€’å½’æœç´¢ src å’Œ include ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
file(GLOB_RECURSE SRC_FILES
        "${CMAKE_SOURCE_DIR}/src/*.cpp"
        "${CMAKE_SOURCE_DIR}/src/*.c"
        "${CMAKE_SOURCE_DIR}/*.cc"
        "${CMAKE_SOURCE_DIR}/*.cpp" # å…¼å®¹æ ¹ç›®å½•
)

file(GLOB_RECURSE HEADER_FILES
        "${CMAKE_SOURCE_DIR}/include/*.h"
        "${CMAKE_SOURCE_DIR}/include/*.hpp"
        "${CMAKE_SOURCE_DIR}/*.h"
)

# å¤„ç†å¤–éƒ¨åŒ…è·¯å¾„
if (NOT PUBLIC_PACKAGE_DIR STREQUAL "NO")
    file(GLOB_RECURSE EXT_SRC
            "${PUBLIC_PACKAGE_DIR}/*.cpp"
            "${PUBLIC_PACKAGE_DIR}/*.cc"
            "${PUBLIC_PACKAGE_DIR}/*.c"
    )
    file(GLOB_RECURSE EXT_HDR
            "${PUBLIC_PACKAGE_DIR}/*.h"
            "${PUBLIC_PACKAGE_DIR}/*.hpp"
    )
    list(APPEND SRC_FILES ${EXT_SRC})
    list(APPEND HEADER_FILES ${EXT_HDR})
endif ()

# æ’é™¤ç¼–è¯‘è¾“å‡ºç›®å½•
list(FILTER SRC_FILES EXCLUDE REGEX "${CMAKE_BINARY_DIR}")
list(FILTER SRC_FILES EXCLUDE REGEX ".*/CMakeFiles/.*")
list(FILTER SRC_FILES EXCLUDE REGEX "${CMAKE_BINARY_DIR}/.*")

# è‡ªåŠ¨æå–æ‰€æœ‰å¤´æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ä½œä¸ºåŒ…å«è·¯å¾„
set(INCLUDE_DIRS "")
foreach (HDR ${HEADER_FILES})
    get_filename_component(DIR ${HDR} DIRECTORY)
    list(APPEND INCLUDE_DIRS ${DIR})
endforeach ()
list(REMOVE_DUPLICATES INCLUDE_DIRS)

# ---------------------------------------------------------------------------------------
# 5. æ„å»ºç›®æ ‡
# ---------------------------------------------------------------------------------------
if (TARGET_TYPE STREQUAL "executable")
    add_executable(${PROJECT_NAME} ${SRC_FILES})
elseif (TARGET_TYPE STREQUAL "static")
    add_library(${PROJECT_NAME} STATIC ${SRC_FILES})
elseif (TARGET_TYPE STREQUAL "shared")
    add_library(${PROJECT_NAME} SHARED ${SRC_FILES})
else ()
    message(FATAL_ERROR "Invalid TARGET_TYPE: ${TARGET_TYPE} (must be executable|static|shared)")
endif ()

# ç»‘å®šå¤´æ–‡ä»¶ç›®å½•
target_include_directories(${PROJECT_NAME} PUBLIC ${INCLUDE_DIRS})

# ---------------------------------------------------------------------------------------
# 6. é“¾æ¥åº“è®¾ç½® (åŒºåˆ†ç³»ç»Ÿ)
# ---------------------------------------------------------------------------------------
if (TARGET_TYPE STREQUAL "executable")
    if (TARGET_OS STREQUAL "windows")
        # Windows å¿…é¡»é“¾æ¥çš„åº“ (ç½‘ç»œã€åŸºç¡€ API)
        target_link_libraries(${PROJECT_NAME} PRIVATE ws2_32 wsock32 iphlpapi shlwapi)
    else()
        # Linux åŸºç¡€ç³»ç»Ÿåº“
        target_link_libraries(${PROJECT_NAME} PRIVATE pthread rt dl m)
    endif()
endif ()

# ---------------------------------------------------------------------------------------
# 7. OpenMP æ”¯æŒ
# ---------------------------------------------------------------------------------------
if (ENABLE_OPENMP)
    find_package(OpenMP REQUIRED)
    if (OpenMP_FOUND)
        message(STATUS "OpenMP support enabled.")
        target_link_libraries(${PROJECT_NAME} PUBLIC OpenMP::OpenMP_CXX)
    endif ()
endif ()

# ---------------------------------------------------------------------------------------
# 8. ç¼–è¯‘ä¿¡æ¯æ±‡æ€»
# ---------------------------------------------------------------------------------------
message(STATUS "------------------------------------------------")
message(STATUS " Project Name:   ${PROJECT_NAME}")
message(STATUS " Target OS:      ${TARGET_OS}")
message(STATUS " Target Type:    ${TARGET_TYPE}")
message(STATUS " Build Type:     ${CMAKE_BUILD_TYPE}")
message(STATUS " Install Dir:    ${CMAKE_INSTALL_PREFIX}")
message(STATUS "------------------------------------------------")